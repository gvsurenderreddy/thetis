
<%= render(:partial => 'common/jkl_calendar_init') %>

<script type="text/javascript">
<!--
var calDisp = new JKL.Calendar("div_cal_disp", "form_schedule", "date");
calDisp.setFunc(
    function() {
      _x("date_wday").innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
      document.form_schedule.submit();
      prog("TOP-RIGHT");
    }
  );
calDisp.setStyle( "frame_color", "#3333CC" );
//-->
</script>

<%
login_user = session[:login_user]
date_string = @date.strftime(Schedule::SYS_DATE_FORM)

@groups_cache ||= {}
@teams_cache ||= {}
%>

<%= form_tag( {:controller => 'schedules', :action => 'index'}, :method => 'post', :name => 'form_schedule', :id => 'form_schedule') %>

<% if params[:user_id].nil? %>
  <table align="center" width="98%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="left" width="30%">
      <% unless login_user.nil? %>
        <table align="left" cellspacing="0" cellpadding="0" width="65">
          <tr>
            <td align="left" nowrap width="30">
              <img class="img_btn" onclick="showNewDetail(); return false;" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/schedule_add.gif" alt="<%= t('btn.create') %>" title="<%= t('btn.create') %>">
            </td>
            <% if login_user.admin? User::AUTH_SCHEDULE %>
            <td width="5"></td>
            <td align="left" nowrap width="30">
              <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/config.gif" alt="<%= t('btn.config') %>" title="<%= t('btn.config') %>" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'schedules', :action => 'configure') %>';">
            </td>
            <% end %>
          </tr>
        </table>
      <% end %>
      </td>
      <td align="center" nowrap width="40%">
        <% if login_user.nil? %>
          &nbsp;&nbsp;<span style="color:navy"><%= t('schedule.login_required') %></span>&nbsp;&nbsp;
        <% end %>
      </td>
      <td align="right" nowrap width="30%">
        <%
        display = [[h(t('schedule.calendar')), 'month'], [h(t('schedule.unit_week')), 'week'], [h(t('schedule.unit_day')), 'day']]
        unless login_user.nil?
          groups_a = login_user.get_groups_a
          groups_a.each do |group_id|
            display << [h(Group.get_name(group_id)), 'group_'+group_id]
          end
          teams_a = login_user.get_teams_a
          teams_a.each do |team_id|
            display << [h(Team.get_name(team_id, @teams_cache)), 'team_'+team_id]
          end
          display << [h(t('group.other_group')), 'group_other']
        end
        %>
        <%= t('cap.display') %> <%= select_tag 'display',
                                 options_for_select(display, params[:display]),
                                 :onchange => "if (this.options[this.selectedIndex].value=='group_other') { showGroupTree(); } else { submit(); prog('TOP-RIGHT'); }"
        %>
      </td>
    </tr>
  </table>

<% else %>
  <table align="center" width="98%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="right">
        <a href="#" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'schedules', :action => 'month', :user_id => params[:user_id]) %>'; return false;">
          <%= t('schedule.back_to_calendar') %>
        </a>
      </td>
    </tr>
  </table>
  <%= hidden_field_tag('display', params[:display]) %>
<% end %>

<table width="100%" cellspacing="0" cellpadding="0">
  <tr>
    <td align="center">
<%
yesterday = @date - 1
tomorrow = @date + 1
last_week = @date - 7
next_week = @date + 7
%>
      <a class="calendar_paging" href="#" onclick="doPageDay('<%= last_week.strftime(Schedule::SYS_DATE_FORM) %>'); return false;">&nbsp;&lt;&lt;&nbsp;</a>&nbsp;&nbsp;
      <a class="calendar_paging" href="#" onclick="doPageDay('<%= yesterday.strftime(Schedule::SYS_DATE_FORM) %>'); return false;">&nbsp;&lt;&nbsp;</a>&nbsp;&nbsp;
      <input name="date" type="text" readonly style="text-decoration:underline; width:105px; text-align:center; font-size:10.5pt; font-family:verdana,arial,helvetica,sans-serif; color:crimson; border:0px; cursor:pointer;" value="<%= date_string %>" onClick="calDisp.write();" /> <span id="date_wday" style="color:crimson;">(<%=h Schedule::wday_name(@date.wday) %>)</span><span id="div_cal_disp"></span>
      &nbsp;&nbsp;<a class="calendar_paging" href="#" onclick="doPageDay('<%= tomorrow.strftime(Schedule::SYS_DATE_FORM) %>'); return false;">&nbsp;&gt;&nbsp;</a>
      &nbsp;&nbsp;<a class="calendar_paging" href="#" onclick="doPageDay('<%= next_week.strftime(Schedule::SYS_DATE_FORM) %>'); return false;">&nbsp;&gt;&gt;&nbsp;</a>
    </td>
  </tr>
</table>

<% unless params[:user_id].nil? %>
  <input type="hidden" name="user_id" value="<%= params[:user_id] %>" />
<% end %>
</form>

<table id="div_schedule" cellspacing="0" cellpadding="0" width="100%">
  <tr>
    <td valign="top">

<div id="div_timetable" style="width:100%; padding:8px 0px;">
  <%= render(:partial => 'timetable', :locals => {:read_only => !params[:user_id].nil?}) %>
</div>

<%= form_tag( {:controller => 'schedules', :action => 'save', :id => params[:id]}, :method => 'post', :name => 'form_detail', :id => 'form_detail') %>
<table cellspacing="0" cellpadding="0" width="100%">
  <tr>
    <td align="center" valign="top">

    <div id="div_schedule_detail">
<%
if session[:edit_schedule].nil?
  unless @schedule.nil?
    if params[:edit_id].nil?
%>
    <%= render(:partial => 'ajax_show_detail') %>
  <% else %>
    <%= render(:partial => 'ajax_edit_detail') %>
<%
    end
  end
else
  @schedule = session[:edit_schedule]
%>
  <%= render(:partial => 'ajax_edit_detail') %>
<%
  session[:edit_schedule] = nil
end
%>
    </div>

    <%= hidden_field_tag('date', date_string) %>

    </td>
  </tr>
</table>
</form>

    </td>
  </tr>
</table>

<script type="text/javascript">
<!--

var reqTargetDay = 0;
var forceTargetAll = 0;

function onLoadSub()
{
<% unless params[:showNew].nil? %>
  showNewDetail();
<% end %>
<% unless params[:doDelete].nil? %>
  _doScheduleDelete("<%= params[:doDelete] %>");
<% end %>
}

function doPageDay(date)
{
  var url = "<%= url_for(:controller => 'schedules', :action => 'day') %>?id=" + date;

<% unless params[:user_id].nil? %>
  url += "&user_id=<%= params[:user_id] %>";
<% end %>

  prog("TOP-RIGHT");
  document.location.href = url;
}

function showNewDetail()
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater(
              "div_schedule_detail",
              "<%= url_for(:controller => 'schedules', :action => 'new') %>",
              {
                method:"get",
                asynchronous:true,
                evalScripts:true,
                onComplete:function(request){ thetisBox.remove(); },
                parameters:Form.serialize(document.form_schedule)
              }
            );
}

function doRegisterDetail(schedule_id)
{
  // Check
  if (_x("schedule_title").value.length <= 0) {
    msg("<%= t('schedule.specify_title') %>");
    return;
  }

  if (!_x("schedule_scope_all").checked
      && _x("users_selected").length <= 0
      && _x("groups_selected").length <= 0
      && _x("teams_selected").length <= 0) {
    msg("<%= t('schedule.specify_members') %>");
    return;
  }

  if (_x("equipment_selected").length > 0 && _x("schedule_scope_private").checked) {
    msg("<%= t('schedule.private_cannot_reserve_equipment') %>");
    return;
  }

  if (!_x("schedule_scope_all").checked && !_x("schedule_scope_public").checked && !_x("schedule_scope_private").checked) {
    msg("<%= t('schedule.select_scope') %>");
    return;
  }

  var selected_target = null;
  var repeat_update_target = document.form_detail.repeat_update_target;
  if (repeat_update_target != null) {
    for (var i=0; i<repeat_update_target.length; i++) {
      if (repeat_update_target[i].checked) {
        selected_target = repeat_update_target[i].value;
        break;
      }
    }
    if (forceTargetAll <= 0 && reqTargetDay > 0 && document.form_detail.is_repeat.checked) {
      if (selected_target == null) {
        msg("<%= t('msg.select_update_target') %>");
        return;
      }
    }
  }

  var is_allday = _x("schedule_allday").checked;

  if (document.form_detail.is_repeat.checked) {

    // for Repeat
    // Time
    if (!is_allday) {
      var start = new Date(2000, 1, 1, _x("repeat_start_hour").value, _x("repeat_start_min").value, 0);
      var end = new Date(2000, 1, 1, _x("repeat_end_hour").value, _x("repeat_end_min").value, 0);
      if (start > end) {
        msg("<%= t('msg.specify_valid_time_term') %>");
        return;
      }
    }

    // Term
    var startDate = _x("schedule_repeat_start").value.split("-");
    var endDate = _x("schedule_repeat_end").value.split("-");

    start = new Date(startDate[0], startDate[1], startDate[2], 0, 0, 0);
    end = new Date(endDate[0], endDate[1], endDate[2], 0, 0, 0);
    if (start > end) {
      msg("<%= t('msg.specify_valid_time_term') %>");
      return;
    }

    // Rule
    if (_x("repeat_rules").length <= 0) {
      msg("<%= t('schedule.specify_repeat_rule') %>");
      return;
    }

    if (is_allday) {
      _x("schedule_start").value = null;
      _x("schedule_end").value = null;
    } else {
      _x("schedule_start").value = "2000-01-01 "+_x("repeat_start_hour").value+":"+_x("repeat_start_min").value;
      _x("schedule_end").value = "2000-01-01 "+_x("repeat_end_hour").value+":"+_x("repeat_end_min").value;
    }

  } else {

    // for Once
    var startDate = _x("start_date").value.split("-");
    var endDate = _x("end_date").value.split("-");

    if (is_allday) {
      _x("once_start_hour").value = 0;
      _x("once_start_min").value = 0;
      _x("once_end_hour").value = 0;
      _x("once_end_min").value = 0;
    }

    var start = new Date(startDate[0], startDate[1], startDate[2], _x("once_start_hour").value, _x("once_start_min").value, 0);
    var end = new Date(endDate[0], endDate[1], endDate[2], _x("once_end_hour").value, _x("once_end_min").value, 0);
    if (start > end) {
      msg("<%= t('msg.specify_valid_time_term') %>");
      return;
    }

    _x("schedule_start").value = _x("start_date").value+" "+_x("once_start_hour").value+":"+_x("once_start_min").value
    _x("schedule_end").value = _x("end_date").value+" "+_x("once_end_hour").value+":"+_x("once_end_min").value

    if (is_allday) {
      _x("schedule_start").value += " GMT";
      _x("schedule_end").value += " GMT";
    }
  }

  selectListAll(_x("repeat_rules"));
  selectListAll(_x("users_selected"));
  selectListAll(_x("groups_selected"));
  selectListAll(_x("teams_selected"));
  selectListAll(_x("equipment_selected"));
  selectListAll(_x("excepts"));
  selectListAll(_x("items_selected"));

  var thetisBox = prog("TOP-RIGHT");
  document.form_detail.action = "<%= url_for(:controller => 'schedules', :action => 'save') %>?id=" + schedule_id;
  document.form_detail.submit();

/* No Ajax because of the case in which a different day is specified.
  new Ajax.Updater(
            "div_timetable",
            "<%= url_for(:controller => 'schedules', :action => 'save') %>?id="+schedule_id,
            {
              asynchronous:true,
              evalScripts:true,
              onComplete:function(request){
                thetisBox.remove();

                _x("div_schedule_detail").innerHTML = "";

                if (is_MS) {    // Bugfull IE6.x/7.0 has a lot of serious BUGs in arrignment.
                  doResize();
                  _x("main_div").style.overflow = "";
                }
                tips("<%= t('msg.register_success') %>");
              },
              parameters:Form.serialize(document.form_detail)
            }
          );
*/
}

function showScheduleDetail(date, id, title)
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater(
              "div_schedule_detail",
              "<%= url_for(:controller => 'schedules', :action => 'show') %>?id="+id,
              {
                method:"get",
                asynchronous:true,
                evalScripts:true,
                onComplete:function(request){ thetisBox.remove(); },
                parameters:Form.serialize(document.form_schedule)
              }
            );
}

function editScheduleDetail(date, id)
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater(
              "div_schedule_detail",
              "<%= url_for(:controller => 'schedules', :action => 'edit') %>?id="+id,
              {
                method:"get",
                asynchronous:true,
                evalScripts:true,
                onComplete:function(request){
                  thetisBox.remove();
/* GREP WITH BUGFULL-IE!
                  if (is_MS) {    // Bugfull IE6.x/7.0 has a lot of serious BUGS in arrignment.
                    var div_schedule = _x("div_schedule");
                    if (Number(div_schedule.style.height.replace(/px/, "")) != div_schedule.offsetHeight) {
                      div_schedule.style.height = div_schedule.offsetHeight + "px";
                    }
                  }
*/
                },
                parameters:Form.serialize(document.form_schedule)
              }
            );
}

function doScheduleDelete(date, id, title)
{
  if (title == null) {
    return;
  }
  confm("<%= t('paren.square.left') %>" + title + "<%= t('schedule.confirm_to_delete') %>", "_doScheduleDelete("+id+")");
}

function _doScheduleDelete(id)
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater(
            "div_timetable",
            "<%= url_for(:controller => 'schedules', :action => 'destroy') %>?id="+id,
            {
              asynchronous:true,
              evalScripts:true,
              onComplete:function(request){ thetisBox.remove(); _x("div_schedule_detail").innerHTML=""; },
              parameters:Form.serialize(document.form_schedule)
            }
          );
}

function showFolderTreeToSelect(folder_id, schedule_id)
{
  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setFormTag("<form action=\"<%= url_for(:controller => 'schedules', :action => 'get_folder_items') %>\" onsubmit=\"new Ajax.Updater('div_selectItems', '<%= url_for(:controller => 'schedules', :action => 'get_folder_items') %>', {method:'get', asynchronous:true, evalScripts:true, onComplete:function(request){__thetisBoxProgress.remove();}, parameters:Form.serialize(this)}); return false;\">");
  if (schedule_id != null && schedule_id.length > 0) {
    thetisBox.setAdditionalParams(new Array("schedule_id="+schedule_id));
  }
  thetisBox.show("CENTER", "", "TREE", "", "<%= t('msg.select_folder_to_show')%>", "");
  thetisBox.setTree("<%= url_for(:controller => 'folders', :action => 'ajax_get_tree') %>", folder_id);
}

function showGroupTree()
{
  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setFormTag("<form action=\"<%= url_for(:controller => 'schedules', :action => 'get_group_users') %>\" onsubmit=\"var display=_x('display'); display.options[display.selectedIndex].value='group_'+ThetisBox.getTreeSelect("+thetisBox.id+"); document.form_schedule.submit(); return false;\">");
  thetisBox.show("CENTER", "", "TREE", "", "<%= t('group.select_to_show')%>", "");
  thetisBox.setTree("<%= url_for(:controller => 'groups', :action => 'ajax_get_tree') %>", "");
}

//-->
</script>

