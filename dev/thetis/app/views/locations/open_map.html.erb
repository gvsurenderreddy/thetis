
<%
login_user = session[:login_user]
@users_cache = {}
@user_obj_cache = {}

@user_groups = {}
@groups_cache = {}
@group_obj_cache = {}
%>

<%
if !@office_map.nil? and @office_map.img_enabled
  img_url = url_for(:controller => 'locations', :action => 'get_image', :id => @office_map.id, :ts => ApplicationHelper.get_timestamp(@office_map))
else
  img_url = THETIS_RELATIVE_URL_ROOT + '/images/location/default_map.png'
end
%>
<table id="div_desktop" width="100%" cellpadding="0" cellspacing="0" style="background-color:snow; border-left:#4E659A 2px solid; border-top:#4E659A 2px solid; border-right:ivory 2px solid;  border-bottom:ivory 2px solid; display:none;">
  <tr class="desktop_tr">
    <td class="desktop_td" align="center" valign="middle">
      <img id="img_map" src="<%= raw(img_url) %>" style="display:none;" />
    </td>
  </tr>
</table>

<!-- Toolbox -->
<span style="display:none;">
  <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/location/exit_on.png" width="0">
</span>

<table class="toolbar" id="toolbar" width="70%" cellpadding="0" cellspacing="0" style="z-index:999; position:absolute; display:none; background-color:white; border:inset 2px gray;">
  <tr>
    <td width="20" rowspan="3" style="width:20px; cursor:move; background-color:lime; padding-left:10px;">
      &nbsp;
    </td>
    <td width="8%" align="center" valign="middle" rowspan="3" style="padding:3px 20px;">
      <div id="exit" style="height:100%;" onclick="tipsExit()" title="<%= t('office_map.drop_to_remove') %>">
        <img id="exit_img" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/location/exit_off.png" alt="<%= t('office_map.drop_to_remove') %>"></div><!-- Don't divide the line (for browsers without transparent PNG supporting. ) -->
    </td>
    <td width="90%" align="left">
    <%
    if @location.nil?
      location_id = "location_xx"
    %>
      <div class="location_tray" id="<%= location_id %>" align="left" style="width:200px; z-index:1000; cursor:move;">
        <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/<%= login_user.get_figure %>.png" />
        <%= login_user.get_name %>
      </div>
      <%= draggable_element(location_id, :revert => false) %>
    <% end %>
    </td>
  </tr>
  <tr>
    <td align="left" style="padding:3px 0px;">
      <table width="100%" cellspacing="0" cellpadding="0">
         <tr>
          <td align="left" width="120" style="padding-bottom:5px;">
  <% if @group_id.nil? %>
            <table width="120" cellspacing="0" cellpadding="0">
              <tr>
                <td class="td_button_gray" align="left" nowrap bgColor="gray" onClick="showGroupTreeToSelect('0');" onMouseOver="this.bgColor='lawngreen'" onMouseOut="this.bgColor='gray'">
                  <%= t('btn.select_group') %>
                </td>
              </tr>
            </table>
  <% else %>
            <table width="100%" cellpadding="0" cellspacing="0">
              <tr>
                <td align="left" nowrap>
                  <%= t('cap.group') %> <a href="#" onclick="showGroupTreeToSelect('<%= @group_id %>');" onMouseOver="this.style.backgroundColor='palegreen'" onMouseOut="this.style.backgroundColor='white'" style="color:red;"><%=h Group.get_path(@group_id, @groups_cache, @group_obj_cache) %></a>
                  &nbsp; <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/erase.gif" alt="<%= t('btn.clear') %>" title="<%= t('btn.clear') %>" onclick="clearGroup()" />
                </td>
              </tr>
            </table>
  <% end %>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr>
    <td align="left" style="padding:3px 0px;">
      <%= form_tag( {:controller => 'locations', :action => 'open_map'}, :method => 'get', :name => 'form_map') %>
        <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/search.gif" alt="<%= t('cap.search_keywords') %>">
        <%= text_field_tag('keyword', params[:keyword]) %>
        <input type="button" value="<%= t('btn.search') %>" onClick="form_map.submit(); prog('TOP-RIGHT');"/>
        <input type="button" value="<%= t('btn.reset') %>" onClick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'locations', :action => 'open_map') %>';"/>
      </form>
    </td>
  </tr>
</table>
<%= draggable_element('toolbar', :revert => false) %>

<!-- Locations -->
<%
unless @locations.nil?
  @locations.each do |location|
    location_id = "location_#{location.id}"

    width_limit = '';
    width_limit = 'width:200px;' if location.get_name.length >= 30;
%>
  <div class="location_on_map" id="<%= location_id %>" align="left" style="position:absolute; z-index:1000; display:none; <%= width_limit %>">
    <%
    user_name, u_groups, figure = UsersHelper.get_groups_info(location.user_id, @user_groups, @users_cache, @user_obj_cache, @groups_cache, @group_obj_cache)
    icon_img = THETIS_RELATIVE_URL_ROOT + "/images/#{figure}.png"
    is_target = (!@target_user.nil? and @target_user.id == location.user_id)
    %>
    <img src="<%= icon_img %>" style="cursor:move;" />
    <%
    unless u_groups.empty?
    %>
    <a href="#" onclick="showUserGroups('<%= ApplicationHelper.h_s_quote(user_name) %>', '<%= u_groups.join(',') %>', '<%= figure %>'); return false;">
    <% end %>
      <% if is_target %><b style="color:red;"><% end %>
      <%=h truncate(user_name, :length => 30) %>
      <% if is_target %></b><% end %>
    <% unless u_groups.empty? %>
    </a>
    <% end %>
  </div>

  <%= draggable_element(location_id, :revert => false) %>
<%
  end
end
%>

<%= render(:partial => 'common/user_groups') %>

<script type="text/javascript">

var TrayDragObserver = Class.create();
TrayDragObserver.prototype = {
  initialize: function() {
  },
  onStart: function(eventName, draggable, event) {
    var loc = draggable.element;
    if (loc.className != "location_tray") {
      return;
    }

    removeElem(loc);
    document.body.appendChild(loc);   // not on $("div_desktop"), to show over the tray.
    Position.absolutize(loc);

    loc.style.zIndex = 100000;
  },
  onDrag: function(eventName, draggable, event) {
    var loc = draggable.element;
    if (loc.className != "location_tray") {
      return;
    }
  },
  onEnd: function(eventName, draggable, event) {
    var loc = draggable.element;
    if (loc.className != "location_tray") {
      return;
    }
    $("div_desktop").style.backgroundColor = "snow";
    draggable.options.snap = false;
  }
}
Draggables.addObserver( new TrayDragObserver() );

</script>

<script type="text/javascript">
//<![CDATA[
Droppables.add(
        "div_desktop",
        {
          accept: "location_tray",
          onHover:function(element)
          {
            $("div_desktop").style.backgroundColor = "white";
          },
          onDrop:function(element)
          {
            var axis = getAxis($("div_desktop"), element.id);

            new Ajax.Request(
                    "<%= url_for(:controller => 'locations', :action => 'on_moved') %>",
                    {
                      asynchronous:true,
                      evalScripts:true,
                      parameters:"x="+axis[0]+"&y="+axis[1]+"&group_id=<%= @map_group_id %>&authenticity_token=<%= form_authenticity_token %>",
                      onComplete:function(request){
                                    element.id = "location_" + request.responseText;
                                    element.className = "location_on_map";
                                  }
                    }
                  );
          }
        }
      )
//]]>

//<![CDATA[
Droppables.add(
        "exit",
        {
          accept: "location_on_map",
          onHover:function(element)
          {
            $("exit_img").src = "<%= THETIS_RELATIVE_URL_ROOT %>/images/location/exit_on.png";
          },
          onDrop:function(element)
          {
            doRemoveLocation(element.id);
          }
        }
      )
//]]>
</script>


<SCRIPT language="javascript" type="text/javascript">

var desktop = $("div_desktop");
desktop.style.display = "block";

function onLoadSub()
{
  var mainRegion = getClientRegion();
  var mainWidth = mainRegion.width;
  var mainHeight = mainRegion.height;

  var img_map = $("img_map");
  img_map.width = mainWidth * 90 / 100;
  img_map.height = mainHeight * 90 / 100;
  img_map.style.display = "block";

  doResize();

  var deskWidth = desktop.clientWidth;
  var deskHeight = desktop.clientHeight;
  var deskPos = Position.cumulativeOffset(desktop);

<%
unless @locations.nil?
  @locations.each do |location|
%>
  loc = $("location_<%= location.id %>");
  loc.style.left = (deskPos[0] + deskWidth * <%= location.x %> / 10000) + "px";
  loc.style.top = (deskPos[1] + deskHeight * <%= location.y %> / 10000) + "px";
  loc.style.display = "inline";
<%
  end
end
%>

  var toolbar = $("toolbar");
  toolbar.style.display = "inline";
  var toolbarHeight = toolbar.clientHeight;
  toolbar.style.top = (mainHeight - toolbarHeight - 30) + "px";
  toolbar.style.left = "50px";
}

function doRemoveLocation(element_id)
{
  confm("<%= t('office_map.confirm_to_leave') %>", "_doRemoveLocation('"+element_id+"')");
}

function _doRemoveLocation(element_id)
{
  var id = element_id.split("_")[1];

  var thetisBoxProgress = prog("CENTER");

  new Ajax.Request(
          "<%= url_for(:controller => 'locations', :action => 'drop_on_exit') %>?id="+id,
          {
            parameters:"authenticity_token=<%= form_authenticity_token %>",
            asynchronous:true,
            evalScripts:true,
            onComplete:function(request){
              thetisBoxProgress.remove();
              setTimeout(
                  function(){
                    var loc = $(element_id);
                    removeElem(loc);
                  },
                  100
                );
            }
          }
        );
}

function save(location_id)
{
  var desktop = $("div_desktop");

  bound(desktop, location_id);

  var axis = getAxis(desktop, location_id);

  new Ajax.Request(
          "<%= url_for(:controller => 'locations', :action => 'on_moved') %>?id=" + encodeURIComponent(location_id.split("_")[1]),
          {
            asynchronous:true,
            evalScripts:true,
            parameters:"x="+axis[0]+"&y="+axis[1]+"&group_id=<%= @map_group_id %>&authenticity_token=<%= form_authenticity_token %>"
          }
        );
}

var DesktopDragObserver = Class.create();
DesktopDragObserver.prototype = {
  initialize: function() {
  },
  onStart: function(eventName, draggable, event) {
    var elem = draggable.element;
    if (elem.className != "location_on_map"
        && elem.className != "toolbar") {
      return;
    }

    bound($("div_desktop"), elem.id);
  },
  onDrag: function(eventName, draggable, event) {
    var elem = draggable.element;
    if (elem.className != "location_on_map"
        && elem.className != "toolbar") {
      return;
    }
    var elemWidth = elem.clientWidth;
    var elemHeight = elem.clientHeight;
    var elemPos = Position.cumulativeOffset(elem);

    var deskWidth = desktop.clientWidth;
    var deskHeight = desktop.clientHeight;
    var deskPos = Position.cumulativeOffset(desktop);

    if (elemPos[0] < deskPos[0]
        || elemPos[1] < deskPos[1]
        || elemPos[0] + elemWidth > deskPos[0] +deskWidth
        || elemPos[1] + elemHeight > deskPos[1] +deskHeight
       ) {
      try {
        document.selection.empty();
      } catch (e) {}
      draggable.endDrag(event);

      setTimeout("bound($('div_desktop'), '"+elem.id+"');", 100);
    }
  },
  onEnd: function(eventName, draggable, event) {
    var elem = draggable.element;

    if (elem.className == "location_on_map") {
      setTimeout("save('"+elem.id+"');", 100);
      $("exit_img").src = "<%= THETIS_RELATIVE_URL_ROOT %>/images/location/exit_off.png";
    }
  }
}
Draggables.addObserver( new DesktopDragObserver() );

tipsExit = function()
{
  var exitPos = Position.cumulativeOffset($("exit"));
  var x = exitPos[0] + 50;
  var y = exitPos[1] - 50;
  
  var thetisBox = new ThetisBox;
  thetisBox.bgcolor_body = "#FFFF80";
  thetisBox.show(x+","+y, "", "TIPS", "", "<%= t('office_map.drop_to_remove')%>", "");
}

function showGroupTreeToSelect(group_id)
{
  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.show("CENTER", "", "TREE", "<%= url_for(:controller => 'locations', :action => 'open_map') %>", "<%= t('group.select_to_show')%>", "");
  thetisBox.setTree("<%= url_for(:controller => 'groups', :action => 'ajax_get_tree') %>", group_id);
}

function clearGroup()
{
  prog("TOP-RIGHT");
  location.href = "<%= url_for(:controller => 'locations', :action => 'open_map') %>";
}

</SCRIPT>

