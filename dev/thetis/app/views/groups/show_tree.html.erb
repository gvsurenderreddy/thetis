
<div style="padding-top:7px;">

<table id="tree_main" width="100%" cellpadding="0" cellspacing="0" style='background-color:burlywood; border:solid 2px; border-top-color:palegoldenrod; border-left-color:palegoldenrod; border-bottom-color:dimgray; border-right-color:dimgray;' cellspacing='10'>
  <tr>
    <td align="left" nowrap style="padding:5px 20px;">
    <% if session[:login_user].admin?(User::AUTH_GROUP) %>
      <input type="button" value="<%= h t('btn.new') %>" onClick="doCreate(Position.cumulativeOffset(this));" style="width:80px;" />
      <input type="button" value="<%= h t('btn.rename') %>" onClick="doRename(Position.cumulativeOffset(this));" style="width:80px;" />
      <input type="button" value="<%= h t('btn.delete') %>" onClick="doDelete();" style="width:80px;" />
      <input type="button" value="<%= h t('btn.move') %>" onClick="doMove();" style="width:80px;"/>
    <% else %>
      <%=h t('group.only_admin_can_edit_tree') %>
    <% end %>
    </td>
  </tr>
  <tr height="100%">
    <td align="center" style="padding-bottom:7px;">

      <table width="100%" cellspacing="0" cellpadding="0" style="background-color:white;">
        <tr>
          <td id="td_tree" align="left" valign="top" style='border:inset 2px silver; padding:0px;'>
            <%= form_tag( {:controller => 'groups', :action => 'show_tree'}, :method => 'post', :name => 'form_group_tree') %>
              <div id="groupTree" align="left" style="padding:10px; overflow:auto;"></div>
              <input type='hidden' name='selKeeper' id='selKeeper' value='' />
            </form>
          </td>
          <td id="drag_border" width="5" valign="middle" style="background-color:burlywood; cursor:w-resize;">
            <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/grip_vertical.png">
          </td>
          <td id="td_view" align="center" valign="top" style='width:50%; border:inset 2px silver;'>
            <div id="div_view" width="100%" style="overflow:auto;">&nbsp;</div>
          </td>
        </tr>
      </table>

    </td>
  </tr>
</table>

</div>

<%= draggable_element('drag_border', :revert => false, :constraint => '"horizontal"') %>

<script type="text/javascript">
<!--

var BorderDragObserver = Class.create();
BorderDragObserver.prototype = {
  initialize: function() {
  },
  onStart: function(eventName, draggable, event) {
    if (draggable.element.id != "drag_border") {
      return;
    }
    if (!is_MS && !is_Opera) {
      var groupTree = $("groupTree");
      var td_tree = $("td_tree");
      var view = $("div_view");
      var td_view = $("td_view");
      var orgWidthFolderTree = groupTree.offsetWidth;
      var orgWidthView = view.offsetWidth;

      draggable.options.snap = function(x, y){
          groupTree.style.width = (orgWidthFolderTree + x - 10) + "px";
          td_tree.style.width = (orgWidthFolderTree + x) + "px";
          view.style.width = (orgWidthView - x - 10) + "px";
          td_view.style.width = (orgWidthView - x) + "px";
          return [x, y];
        };
    }
  },
  onDrag: function(eventName, draggable, event) {
    if (draggable.element.id != "drag_border") {
      return;
    }
    if (is_MS || is_Opera) {
      var treeMainWidth = $("tree_main").clientWidth;
      var groupTree = $("groupTree");
      var td_tree = $("td_tree");
      var view = $("div_view");
      var td_view = $("td_view");

      var groupTreePos = Position.cumulativeOffset(groupTree);
      var borderPos = Position.cumulativeOffset(draggable.element);

//    alert("borderPos[0]="+borderPos[0]+", groupTreePos[0]="+groupTreePos[0]);

      var leftWidth = borderPos[0] - groupTreePos[0] - 24;
      groupTree.style.width = leftWidth + "px";
      td_tree.style.width = leftWidth + "px";

      view.style.width = (treeMainWidth - leftWidth - 38) + "px";
      td_view.style.width = (treeMainWidth - leftWidth - 38) + "px";
    }
  },
  onEnd: function(eventName, draggable, event) {
    if (draggable.element.id != "drag_border") {
      return;
    }
    if (!is_MS && !is_Opera) {
      draggable.options.snap = false;
    }
  }
}
Draggables.addObserver( new BorderDragObserver() );

function onLoadSub()
{
  <%
  group_folder_open = THETIS_RELATIVE_URL_ROOT + '/images/folder/group_folder_open.gif'
  group_folder_close = THETIS_RELATIVE_URL_ROOT + '/images/folder/group_folder_close.gif'
  %>
  var folderImgs = new Array(
                        new Array("<%=h group_folder_open %>", "<%=h group_folder_close %>")
                      );
  var array = new Array(new Array("0", "/(root)", "", "doGetUsers('0');", 0));
  var firstMenuId = ThetisBox.buildTree("", array, null, "groupTree", "selKeeper", folderImgs);
  <% @group_tree.each do |parent_id, child_groups| %>
  array = new Array(
    <% count = 0 %>
    <% child_groups.each do |group| %>
          new Array("<%= group.id %>", "/<%=h group.name %>", "", "doGetUsers('<%= group.id %>');", 0)
        <%
          count += 1
          if count < child_groups.length
        %>
          ,
        <%
          end
        %>
    <% end %>
        );
  ThetisBox.buildTree("<%= parent_id %>", array, null, "groupTree", "selKeeper", folderImgs, false);
  <% end %>
  //selectTree("selKeeper", firstMenuId, null);
  //doGetUsers(firstMenuId.split(':')[1]);
}

function doCreate(pos)
{
  if (document.form_group_tree.selKeeper.value == "") {
    msg("<%=h t('group.select_parent') %>");
    return;
  }
  var group_id = document.form_group_tree.selKeeper.value.split(":")[1];

  ThetisBox.openTree("groupTree:"+group_id, true);

  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setFormTag("<form action=\"<%= url_for :controller => 'groups', :action => 'create' %>\" method=\"post\" onsubmit=\"new Ajax.Updater('groupTree:"+group_id+"', '<%= url_for :controller => 'groups', :action => 'create' %>', {asynchronous:true, evalScripts:true, insertion:Insertion.Bottom, onComplete:function(request){__thetisBoxProgress.remove();}, parameters:Form.serialize(this)}); return false;\">");
  thetisBox.setAdditionalParams(new Array("selectedGroupId="+group_id, "authenticity_token=<%= form_authenticity_token %>"));
  thetisBox.show((pos[0])+","+(pos[1]+25), "", "INPUT", "", "<%= t('group.specify_name') %>", "");
}

function doRename(pos)
{
  if (document.form_group_tree.selKeeper.value == "") {
    msg("<%=h t('group.select') %>");
    return;
  }
  var group_id = document.form_group_tree.selKeeper.value.split(":")[1];

  if (group_id == "0") {
    msg("<%= h t('group.root_group_restricted') %>");
    return;
  }

  ThetisBox.openTree("groupTree:"+group_id, true);

  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setFormTag("<form action=\"<%= url_for :controller => 'groups', :action => 'rename' %>?id="+group_id+"\" method=\"post\" onsubmit=\"new Ajax.Updater('a_groupTree:"+group_id+"', '<%= url_for :controller => 'groups', :action => 'rename' %>?id="+group_id+"', {asynchronous:true, evalScripts:true, onComplete:function(request){__thetisBoxProgress.remove();}, parameters:Form.serialize(this)}); return false;\">");
  thetisBox.setAdditionalParams(new Array('selectedGroupId='+group_id, "authenticity_token=<%= form_authenticity_token %>"));
  var name = trim($("groupTree:"+group_id+"_name").innerHTML.replace("/", ""));
  thetisBox.show((pos[0])+","+(pos[1]+25), "", "INPUT", "", "<%= t('group.specify_name') %>", name);
}

function doDelete()
{
  if (document.form_group_tree.selKeeper.value == "") {
    msg("<%=h t('group.select') %>");
    return;
  }
  var group_id = document.form_group_tree.selKeeper.value.split(":")[1]; 

  if (group_id == "0") {
    msg("<%= h t('group.root_group_restricted') %>");
    return;
  }

  ThetisBox.openTree("groupTree:"+group_id, true);

  var name = trim($("groupTree:"+group_id+"_name").innerHTML.replace("/", ""));
  confm("<div style='padding-bottom:10px;'><%=h t('paren.square.left') %>"+name+"<%=h t('group.delete_info1') %></div><div style='padding-bottom:10px;'><%=h t('group.delete_info2') %></div><%=h t('msg.confirm_sure') %>", "_doDelete("+group_id+")");
}

function _doDelete(group_id)
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater(
          "base_groupTree:"+group_id,
          "<%= url_for :controller => 'groups', :action => 'destroy' %>?id="+group_id,
          {
            asynchronous:true,
            evalScripts:true,
            onComplete:function(request){
              thetisBox.remove();
              removeElem("base_groupTree:"+group_id);
              document.form_group_tree.selKeeper.value = "";
            },
            parameters:Form.serialize(document.form_group_tree)+"&authenticity_token=<%= form_authenticity_token %>"
          }
        );
}

function doMove()
{
  if (document.form_group_tree.selKeeper.value == "") {
    msg("<%=h t('group.select') %>");
    return;
  }
  var group_id = document.form_group_tree.selKeeper.value.split(":")[1];

  if (group_id == "0") {
    msg("<%= h t('group.root_group_restricted') %>");
    return;
  }

  ThetisBox.openTree("groupTree:"+group_id, true);

  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setAdditionalParams(new Array("authenticity_token=<%= form_authenticity_token %>"));
  thetisBox.show("CENTER", "", "TREE", "<%= url_for :controller => 'groups', :action => 'move' %>?id="+group_id, "<%=h t('group.select_dest')%>", "");
  thetisBox.setTree("<%= url_for :controller => 'groups', :action => 'ajax_get_tree' %>?id="+group_id, "0");
}

function doGetUsers(group_id)
{
  var thetisBox = prog("TOP-RIGHT");
  new Ajax.Updater("div_view", "<%= url_for :controller => 'groups', :action => 'get_users' %>?id="+group_id, {method:"get", asynchronous:true, evalScripts:true, onComplete:function(request){ thetisBox.remove(); }, parameters:Form.serialize(document.form_group_tree)});
}
//-->
</script>
