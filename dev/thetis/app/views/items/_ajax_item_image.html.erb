
<%= render(:partial => 'common/error', :locals => {:obj => @image}) %>

<table align="center" width="90%" cellpadding="0" cellspacing="2">
  <tr height="20"><td></td></tr>
  <tr>
    <td valign="top">
      <table cellspacing="0" cellpadding="0" width="100%">
        <tr>
          <td class="item_cap_td" style="width:100%; background-color:lightpink;"><%= t('item.add_images') %></td>
        </tr>
        <tr>
          <td class="item_value_td" width="80%">
            <table width="100%" cellpadding="0" cellspacing="2">
              <tr>
                <td rowspan="3" width="20" align="center" bgColor="lightcoral">A</td>
                <td class="item_cap_td" style="background-color:pink"><%= t('item.file') %></td>
                <td class="item_value_td">
                  <%= file_field(:image0, :file, :style => 'width:100%', :size => '50') %><br/>
                </td>
              </tr>
              <tr>
                <td class="item_cap_td" style="background-color:pink"><%= Item.human_attribute_name('title') %></td>
                <td class="item_value_td">
                  <%= text_field(:image0, :title, :style => 'width:70%') %><br/>
                </td>
              </tr>
              <tr>
                <td class="item_cap_td" style="background-color:pink"><%= Image.human_attribute_name('memo') %></td>
                <td class="item_value_td">
                  <%= text_area(:image0, :memo, :rows => '3', :wrap => 'off', :style => 'width:100%') %><br/>
                </td>
              </tr>
              <tr height="5"><td></td></tr>
              <tr>
                <td rowspan="3" width="20" align="center" bgColor="lightcoral">B</td>
                <td class="item_cap_td" style="background-color:pink"><%= t('item.file') %></td>
                <td class="item_value_td">
                  <%= file_field(:image1, :file, :style => 'width:100%', :size => '50') %><br/>
                </td>
              </tr>
              <tr>
                <td class="item_cap_td" style="background-color:pink"><%= Item.human_attribute_name('title') %></td>
                <td class="item_value_td">
                  <%= text_field(:image1, :title, :style => 'width:70%') %><br/>
                </td>
              </tr>
              <tr>
                <td class="item_cap_td" style="background-color:pink"><%= Image.human_attribute_name('memo') %></td>
                <td class="item_value_td">
                  <%= text_area(:image1, :memo, :rows => '3', :wrap => 'off', :style => 'width:100%') %><br/>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </td>
    <td style="width:10px;"></td>
    <td id="sortable_images" align="center" width="150" valign="top">
    <%
    item_images = @item.images_without_content
    item_images.each_with_index do |img, idx|
    %>
      <div id="item_<%= img.id %>" width="100%">
        <table cellspacing="0" cellpadding="0" width="100%">
          <tr>
            <td align="right" valign="middle" style="cursor:move;">
            <% if item_images.size > 1 %>
              <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/up_down.gif" alt="<%= t('msg.drag_to_change_orger') %>" />
            <% end %>
            </td>
            <td class="img_td" align="center" style="padding-left:5px; padding-right:5px; cursor:move;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td align="center">
                    <% img_url = url_for(:controller => 'items', :action => 'get_image', :id => img.id, :ts => ApplicationHelper.get_timestamp(img)) %>
                    <img id="<%= "img#{img.id}" %>" src="<%= img_url %>" width="90" height="60" />
                  </td>
                </tr>
                <tr>
                  <td align="center">
                  <% if img.title.nil? or img.title.empty? %>
                    <%=h truncate(img.name, :length => 20) %>
                  <% else %>
                    &lt;<%=h truncate(img.title, :length => 18) %>&gt;
                  <% end %>
                  </td>
                </tr>
              </table>
            </td>
            <td valign="middle">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td>
                    <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/edit.gif" alt="<%= t('btn.edit') %>" title="<%= t('btn.edit') %>" onclick="editImageInfo(<%= img.id %>, '<%=ApplicationHelper.h_s_quote img.name %>');" />
                  </td>
                </tr>
                <tr height="5"><td></td></tr>
                <tr>
                  <td>
                    <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/delete.gif" alt="<%= t('btn.delete') %>" title="<%= t('btn.delete') %>" onclick="doDeleteImage(<%= img.id %>, '<%=ApplicationHelper.h_s_quote((img.title.nil? or img.title.empty?)?(img.name):(img.title)) %>');" />
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr height="10"><td></td></tr>
        </table>
      </div>
    <% end %>
    </td>
  </tr>
</table>


<script type="text/javascript">

setSortableImg = function() {
  // Following code in HTML body such as "sortable_element" tag causes a JavaScript error in dojo.io.bind.
  Sortable.create("sortable_images", {onUpdate:function(){new Ajax.Request("<%= url_for(:controller => 'items', :action => 'update_images_order') %>?id="+_x("item_id").value, {asynchronous:true, evalScripts:true, parameters:Sortable.serialize("sortable_images", {name:"images_order"})+"&authenticity_token=<%= form_authenticity_token %>"})}, tag:"div"})
}

<% if item_images.size > 1 and params[:action] == 'edit' %>
setTimeout(setSortableImg, 100);
<% end %>

var thetisBoxImageInfo = null;

editImageInfo = function(img_id, img_name)
{
  if (thetisBoxImageInfo != null) {
    return;
  }
  thetisBoxImageInfo = new ThetisBox;
  thetisBoxImageInfo.setOnClose(function(){ thetisBoxImageInfo = null; });

  var thetisBoxProgress = prog("CENTER");

  new Ajax.Request(
          "<%= url_for(:controller => 'items', :action => 'edit_image_info') %>?image_id="+img_id,
          {
            method:"get",
            asynchronous:true,
            evalScripts:true,
            onComplete:function(request) {
                thetisBoxImageInfo.title = img_name;
                thetisBoxImageInfo.show("CENTER", "460,390", "TRAY", "", "", request.responseText.stripScripts());
                thetisBoxProgress.remove();
                request.responseText.evalScripts();
              }
          }
        );
}

onImageInfoOK = function()
{
  var btnOk = _x("image_info_ok");
  btnOk.disabled = true;
  var btnCancel = _x("image_info_cancel");
  btnCancel.disabled = true;

  var thetisBoxProgress = prog("CENTER");

  ajaxUploadFile(
          "form_image_info",
          document.form_image_info.action,
          "div_item_image",
          function() {
              setTimeout(setSortableImg, 100);
              thetisBoxProgress.remove();
              thetisBoxImageInfo.remove();
              tips("<%= t('msg.update_success')%>");
          },
          function() {
              thetisBoxProgress.remove();
              btnOk.disabled = false;
              btnCancel.disabled = false;
              msg("<%= t('msg.system_error')%>");
          }
        );
}

onImageInfoCancel = function()
{
  thetisBoxImageInfo.remove();
}

doDeleteImage = function(img_id, title)
{
  confm("<%= t('paren.square.left') %>"+title+"<%= t('msg.confirm_to_delete') %>", "_doDeleteImage("+img_id+")");
}

_doDeleteImage = function(img_id)
{
  var thetisBox = prog("TOP-RIGHT");

  new Ajax.Updater(
              "div_item_image",
              "<%= url_for(:controller => 'items', :action => 'delete_image') %>",
              {
                asynchronous:true,
                evalScripts:true,
                onComplete:function(request) {
                  thetisBox.remove();
                },
                parameters: "image_id="+img_id+"&authenticity_token=<%= form_authenticity_token %>"
              }
            );
}

</script>
