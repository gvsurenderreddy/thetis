
<%
@groups_cache ||= {}
@group_obj_cache ||= {}
%>

<%= form_tag( {:controller => 'users', :action => 'list'}, :method => 'get', :name => 'form_list') %>

<table width="100%" cellspacing="0" cellpadding="0" style="padding-bottom:5px;">
  <tr>
  <% if @login_user.admin?(User::AUTH_USER) %>
    <td align="left" nowrap width="1%">
      <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/user_add.gif" alt="<%= t('btn.create') %>" title="<%= t('btn.create') %>" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'users', :action => 'new', :from => 'users_list') %>';">
    </td>
    <td width="10"></td>
    <td align="left" nowrap width="1%">
      <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/csv_exp.gif" alt="<%= t('btn.export_csv') %>" title="<%= t('btn.export_csv') %>" onclick="exportCsv();">
    </td>
    <td width="10"></td>
    <td align="left" nowrap width="1%">
      <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/csv_imp.gif" alt="<%= t('btn.import_csv') %>" title="<%= t('btn.import_csv') %>" onclick="importCsv();">
    </td>
    <td width="10"></td>
    <td align="left" nowrap width="1%">
      <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/icons/config.png" alt="<%= t('btn.config') %>" title="<%= t('btn.config') %>" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'users', :action => 'configure') %>';">
    </td>
  <% end %>
    <td align="right" nowrap>
      <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/search.gif" alt="<%= t('cap.search_keywords') %>">&nbsp;<%= text_field_tag 'keyword', params[:keyword] %>
      <input type="button" value="<%= t('btn.search') %>" onClick="form_list.action='<%= url_for(:controller => 'users', :action => 'search') %>'; form_list.submit(); prog('TOP-RIGHT');"/>
      <input type="button" value="<%= t('btn.reset') %>" onClick="location.href='<%= url_for(:controller => 'users', :action => 'list') %>'; prog('TOP-RIGHT');"/>
    </td>
  </tr>
</table>

<table width="100%" cellspacing="0" cellpadding="0" style="padding-bottom:5px;">
  <tr>
    <td align="left" nowrap>
<% if @group_id.nil? or @group_id.empty? %>
      <div class="button_gray" style="float:left;" onClick="showGroupTreeToSelect('0');">
        <%= t('btn.select_group') %>
      </div>
<% else %>
      <%= t('cap.group') %> <a href="#" onclick="showGroupTreeToSelect('<%= @group_id %>');" onMouseOver="this.style.backgroundColor='palegreen'" onMouseOut="this.style.backgroundColor='white'" style="color:red;"><%= Group.get_path(@group_id, @groups_cache, @group_obj_cache) %></a>
      &nbsp; <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/erase.gif" alt="<%= t('btn.clear') %>" title="<%= t('btn.clear') %>" onclick="clearGroup()" />
<% end %>
    </td>
    <td align="right" nowrap>
<% if @login_user.admin?(User::AUTH_USER) %>
      <input type="button" value="<%= t('btn.select_deselect_all')%>" onclick="selectAll();">
      <span style="color:silver;">|</span>
      <input type="button" value="<%= t('btn.delete')%>" onclick="doDelete();">
      <input type="button" value="<%= t('btn.send_notification')%>" onclick="doNotify();">
<% else %>
      &nbsp;
<% end %>
    </td>
  </tr>
</table>

<table width="100%" cellpadding="0" cellspacing="0" style="padding-bottom:7px;">
  <tr>
    <td class="pagination_td" align="center">
      <%= t('cap.total') %><%= t('user', :count => @total_num) %>
      <%
      prms = ApplicationHelper.dup_hash(params)
      prms.delete('authenticity_token')
      prms.delete('check_user')
      prms['action'] = 'list'
      pagination = will_paginate(@user_pages, :params => prms)
      pagination = ApplicationHelper.custom_pagination(pagination)
      %>
      <%= raw(pagination) %>
    </td>
  </tr>
</table>

<div class="base_list" id="div_users">
<table id="list_users" width="100%" cellpadding="0" cellspacing="1">
  <tr>
    <th class="list_sort" width="5%"  nowrap onclick="sortList('User.id')"><%= t('activerecord.attributes.id') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('User.id', @sort_col, @sort_type)) %></span></th>
    <th class="list_sort" width="16%" nowrap onclick="sortList('name')"><%= t('user.u_name') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('name', @sort_col, @sort_type)) %></span></th>
    <th class="list_sort" width="20%" nowrap onclick="sortList('fullname')"><%= User.human_attribute_name('fullname') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('fullname', @sort_col, @sort_type)) %></span></th>
    <th class="list_sort" width="26%"  nowrap onclick="sortList('email')"><%= User.human_attribute_name('email') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('email', @sort_col, @sort_type)) %></span></th>
    <th class="list_sort" width="10%"  nowrap onclick="sortList('xorder')"><%= t('user.title') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('xorder', @sort_col, @sort_type)) %></span></th>
    <th class="list_sort" width="20%"  nowrap onclick="sortList('groups')"><%= User.human_attribute_name('organization') %><span class="sort_direction"><%= raw(ApplicationHelper.get_sort_direction_exp('groups', @sort_col, @sort_type)) %></span></th>
  </tr>
<% @users.each_with_index do |user, idx|  %>
  <% td_class = (idx % 2 == 1) ? 'list_td_on' : 'list_td_off' %>
  <tr height="33">
    <td class="<%= td_class %>" nowrap style="text-align:right;"><%= user.id %></td>
    <td  class="<%= td_class %>"nowrap>
      <a class="a_underline" href="#" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'users', :action => 'show', :id => user.id) %>'; return false;">
        <%= truncate(user.name, :length => 20) %>
      </a>
    </td>
    <td class="<%= td_class %>" nowrap><%= truncate(user.fullname, :length => 30) %></td>
    <td class="<%= td_class %>" nowrap><%= truncate(user.email, :length => 30) %></td>
    <td class="<%= td_class %>" nowrap><%= truncate(user.title, :length => 10) %></td>
    <td class="<%= td_class %>" nowrap>
      <% user.get_groups_a.each do |group_id| %>
        <%= Group.get_path(group_id, @groups_cache, @group_obj_cache) %><br/>
      <% end %>
    </td>
  <% if @login_user.admin?(User::AUTH_USER) %>
    <td class="<%= td_class %>" nowrap style="text-align:center;">
      <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/edit.gif" alt="<%= t('btn.edit') %>" title="<%= t('btn.edit') %>" onclick="prog('TOP-RIGHT'); location.href='<%= url_for(:controller => 'users',:action => 'edit', :id => user.id, :from => 'users_list') %>';" />
    </td>
    <td class="<%= td_class %>" width="20" style="text-align:center;">
      <%= check_box(:check_user, user.id, :class => 'check_user') %>
    </td>
  <% end %>
  </tr>
<% end %>
</table>
</div>

<%= hidden_field_tag('sort_col', params[:sort_col]) %>
<%= hidden_field_tag('sort_type', params[:sort_type]) %>
<%= hidden_field_tag('group_id', @group_id) %>

</form>

<script type="text/javascript">

var thetisBox = null;

function selectAll()
{
  var elems = document.getElementsByClassName("check_user", document.form_list);
  var all_selected = true;
  for (var i=0; elems != null && i < elems.length; i++) {
    if (!elems[i].checked) {
      all_selected = false;
      break;
    }
  }
  for (var i=0; elems != null && i < elems.length; i++) {
    elems[i].checked = !all_selected;
  }
}

function exportCsv()
{
  if (thetisBox != null){
    thetisBox.remove();
    thetisBox = null;
  }

  var content = getEncodingSelector("doExportCsv()", "export");

  thetisBox = new ThetisBox;
  thetisBox.title = "<%= t('user.title_export') %>";
  thetisBox.show("CENTER", "380,280", "TRAY", "", "<%= t('msg.select_encoding') %> ", content);
}

function doExportCsv()
{
  var enc = null;
  for (var i=0; i<document.form_enc.enc.length; i++) {
    if (document.form_enc.enc[i].checked) {
      enc = document.form_enc.enc[i].value;
      break;
    }
  }
  if (enc == null) {
    return;
  }
  thetisBox.remove();
  thetisBox = null;

  // prog("TOP-RIGHT");
  location="<%= url_for(:controller => 'users', :action => 'export_csv') %>?enc="+enc;
}

function importCsv()
{
  if (thetisBox != null){
    thetisBox.remove();
    thetisBox = null;
  }

  var content = getEncodingSelector("doImportCsv()", "import");

  thetisBox = new ThetisBox;
  thetisBox.title = "<%= t('user.title_import') %>";
  thetisBox.show("CENTER", "380,455", "TRAY", "", "<%= t('user.specify_csv_encoding') %> ", content);
}

function doImportCsv()
{
  if (document.form_enc.imp_file.value == "") {
    msg("<%= t('user.specify_csv') %>");
    return "";
  }
  var enc = null;
  for (var i=0; i<document.form_enc.enc.length; i++) {
    if (document.form_enc.enc[i].checked) {
      enc = document.form_enc.enc[i].value;
      break;
    }
  }
  if (enc == null) {
    msg("<%= t('user.select_encoding_of_csv') %>");
    return;
  }
  var mode = null;
  for (var i=0; i<document.form_enc.mode.length; i++) {
    if (document.form_enc.mode[i].checked) {
      mode = document.form_enc.mode[i].value;
      break;
    }
  }
  if (mode == null) {
    msg("<%= t('msg.select_import_mode') %>");
    return;
  }

  document.form_enc.method = "post";
  document.form_enc.action = "<%= url_for(:controller => 'users', :action => 'import_csv') %>";
  document.form_enc.submit();

  prog("TOP-RIGHT");

  thetisBox.hide();
}

function doDelete()
{
  var elems = document.getElementsByClassName("check_user", document.form_list);
  var count=0;
  for (var i=0; elems!=null && i<elems.length; i++) {
    if (elems[i].checked) {
      var user_id = elems[i].id.split("_")[2];
      if (user_id == "<%= @login_user.id %>") {
        msg("<%= t('user.cannot_remove_yourself') %>");
        return;
      }
      count++;
    }
  }
  if (count <= 0) {
    return;
  }
  confm(count+"<%= t('user.confirm_to_delete') %>", "_doDelete()");
}

function _doDelete()
{
  document.form_list.action = "<%= url_for(:controller => 'users', :action => 'destroy') %>";
  document.form_list.method = "post";
  addInputHidden(document.form_list, null, "authenticity_token", "<%= form_authenticity_token %>");
  document.form_list.submit();

  prog("TOP-RIGHT");
}

function doNotify()
{
  var additionalParams = new Array("authenticity_token=<%= form_authenticity_token %>");

  var elems = document.getElementsByClassName("check_user", document.form_list);
  var count=0;
  for (var i=0; elems!=null && i<elems.length; i++) {
    if (elems[i].checked) {
      var user_id = elems[i].id.split("_")[2];
      additionalParams.push("check_user["+user_id+"]=1");
      count++;
    }
  }
  if (count <= 0) {
    msg("<%= t('msg.select_users_to_notify') %>");
    return false;
  }

  var thetisBox = new ThetisBox;
  thetisBox.setAdditionalParams(additionalParams);
  thetisBox.progress = true;
  thetisBox.show(
                "CENTER", "540,200", "TEXTAREA",
                "<%= url_for(:controller => 'users', :action => 'notify') %>",
                "<%= t('msg.notify_info1') %>"+count+"<%= t('msg.notify_info2') %><br/><%= t('msg.notify_info3') %>",
                ""
              );
}

function clearGroup()
{
  document.form_list.group_id.value = "";
  document.form_list.submit();
  prog("TOP-RIGHT");
}

function sortList(col)
{
  var type = "<%= @sort_type %>";
  
  if (col == "<%= @sort_col %>") {
    type = (type == "ASC") ? "DESC" : "ASC";
  }

  document.form_list.sort_col.value = col;
  document.form_list.sort_type.value = type;
  document.form_list.submit();
  prog("TOP-RIGHT");
}

function showGroupTreeToSelect(group_id)
{
  var thetisBox = new ThetisBox;
  thetisBox.progress = true;
  thetisBox.setAdditionalParams(new Array("authenticity_token=<%= form_authenticity_token %>"));
  thetisBox.show("CENTER", "", "TREE", "<%= url_for(:controller => 'users', :action => 'list') %>", "<%= t('group.select_to_show')%>", "");
  thetisBox.setTree("<%= url_for(:controller => 'groups', :action => 'ajax_get_tree') %>", group_id);
}

</script>

<%
unless @imp_errs.nil? or @imp_errs.empty?
%>

<div id="imp_errs" style="display:none;">
<table align="center" valign="top" width="100%" cellspacing="0" cellpadding="0">
  <tr style="height:20px;">
    <td align="right" style="color:blueviolet; padding-right:10px; padding-top:10px;">
      <%= @imp_cnt.to_s + t('user.imported') %><br/>
    </td>
  </tr>
  <tr>
    <td valign="top" style="padding:10px;">
      <table align="center" valign="top" width="100%" cellspacing="0" cellpadding="0" border="1">
<%
err_cnt = 0
@imp_errs.each do |user_cnt, errs|
  if err_cnt < 20
%>
        <tr>
        <% if user_cnt > 0 %>
          <td align="right" valign="top" style="padding:0px 3px;">
            <%= user_cnt.to_s + t('user.err_list_cap') %>
          </td>
          <td align="left" valign="top" style="padding:0px 3px;">
        <% else %>
          <td align="left" valign="top" style="padding:0px 3px;" colspan="2">
        <% end %>
        <% errs.each do |err| %>
            &bull; <%= err %><br/>
        <% end %>
          </td>
        </tr>
<% else %>
        <tr>
          <td colspan="2" align="center" valign="top" nowrap style="padding-left:3px; padding-right:3px;">
            <b>...</b>
          </td>
        </tr>
<%
    break
  end
  err_cnt += 1
end
%>
      </table>
    </td>
  </tr>
</table>
</div>

<script type="text/javascript">

function showImportError()
{
  var thetisBox = new ThetisBox;
  thetisBox.title = "<%= t('cap.import_error') %>";
  thetisBox.bgcolor_title = "crimson";
  thetisBox.bgcolor_body = "salmon";
  thetisBox.show("CENTER", (mainWidth*7/10)+",450", "TRAY", "", "<%= t('msg.error_detected') %>", _z("imp_errs").innerHTML);
}

function onLoadSub()
{
  setTimeout("showImportError()", 100);
}

</script>

<% end %>

<%= render(:partial => 'common/encoding_selector') %>
