
<%= form_tag( {:controller => 'workflows', :action => 'create' }, :name => 'form_workflow', :method => 'post') %>

<table id="div_workflow_list" width="100%" cellspacing="0" cellpadding="0" style="background-color:wheat; border:solid 2px; border-top-color:#FBE2B1; border-left-color:#FBE2B1; border-bottom-color:dimgray; border-right-color:dimgray;">
  <tr>
    <td width="50%" valign="top" style="padding:5px;">

        <table align="center" width="100%" cellpadding="0" cellspacing="0">
          <tr>
            <td align="center" nowrap style="padding:2px 0px; background-color:burlywood;">
              <%= t('btn.create') %>
            </td>
          </tr>
          <tr>
            <td align="center">
              <span style="color:blueviolet; float:left;"><%= t('workflow.select_to_issue') %></span><br/>
              <select id="select_workflow" name="select_workflow" class="select_multi" size="5" style="width:100%;">
              <%
              unless @tmpl_workflows_folder.nil?
                @group_obj_cache ||= {}
                group_ids = @login_user.get_groups_a(true, @group_obj_cache)
                unless group_ids.include?('0')
                  group_ids << '0'
                end
                group_ids.each do |group_id|
                  sql = WorkflowsHelper.get_tmpl_list_sql(@tmpl_workflows_folder.id, group_id)
                  workflows = Workflow.find_by_sql(sql)
                  next if workflows.nil?

                  workflows.each do |workflow|
                    item = workflow.item
                    next if item.nil?
              %>
                <option value="<%= item.id %>"><%=h item.title %></option>
              <%
                  end
                end
              end
              %>
              </select>
              <div class="button_gray" style="display:block; margin:2px auto 0;" onClick="doCreate();">
                <%= raw(t('arrow.down')) %> <%= t('btn.create') %>
              </div>
            </td>
          </tr>

          <tr height="10"><td></td></tr>

          <tr>
            <td align="center" nowrap style="padding:2px 0px; background-color:burlywood;">
              <%= t('workflow.issuing_list') %>&nbsp;
              <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/info.gif" onclick="msg('<%=ApplicationHelper.h_s_quote t('workflow.issuing_list_info') %>');">
            </td>
          </tr>
          <tr height="5"><td></td></tr>
          <tr>
            <td>
              <div id="div_ajax_workflow" width="100%" style="overflow:auto; background-color:white; border:2px solid dimgray; border-right:2px solid lightgrey; border-bottom: 2px solid lightgrey;">
                <%= render(:partial => 'ajax_workflow') %>
              </div>
            </td>
          </tr>
        </table>

    </td>
    <td width="50%" valign="top" style="padding:5px;">

        <table align="center" width="100%" cellpadding="0" cellspacing="0">
          <tr>
            <td align="center" nowrap style="padding:2px 0px; background-color:burlywood;">
              <%= t('workflow.received_list') %>&nbsp;
              <img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/info.gif" onclick="msg('<%= t('workflow.received_list_info') %><br/><%= t('arrow.right_full') %><%=ApplicationHelper.h_s_quote Workflow.decided_inbox %>');">
            </td>
          </tr>
          <tr height="5"><td></td></tr>
          <tr>
            <td>
              <div id="workflow_list_received" width="100%" style="overflow:auto; background-color:white; border:2px solid dimgray; border-right:2px solid lightgrey; border-bottom: 2px solid lightgrey;">
                <%= render(:partial => 'received_list') %>
              </div>
            </td>
          </tr>
        <% if WorkflowsHelper.exists_decided_inbox?(@login_user.id) %>
          <tr height="5"><td></td></tr>
          <tr>
            <td align="center">
              <table cellspacing="0" cellpadding="0" width="300" align="center" onclick="showDecidedInbox(<%= WorkflowsHelper.get_decided_inbox(@login_user.id).id %>);" style="background:url('<%= THETIS_RELATIVE_URL_ROOT %>/images/flat_button.png') left no-repeat; cursor:pointer;">
                <tr height="35">
                  <td width="15"></td>
                  <td width="20" align="center">
                    <img src="<%= THETIS_RELATIVE_URL_ROOT %>/images/folder/folder.gif">
                  </td>
                  <td align="left" style="padding-left:10px">
                    <span id="divWfStatus" style="color:black;" title="<%=h Workflow.decided_inbox %>"><%=h truncate(Workflow.decided_inbox, :length => 30) %></span><br/>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

<script type="text/javascript">
function showDecidedInbox(folder_id)
{
  var thetisBoxProgress = prog("CENTER");

  var thetisBox = new ThetisBox;

  new Ajax.Request(
          "<%= url_for(:controller => 'folders', :action => 'get_items') %>?id=" + folder_id + "&read_only=true",
          {
            method:"get",
            asynchronous:true,
            evalScripts:true,
            onComplete:function(request) {
                thetisBox.title = "<%=h Workflow.decided_inbox %>";
                thetisBox.overflow = "scroll";
                thetisBox.show(
                          "CENTER",
                          mainWidth*80/100+"," + mainHeight*80/100,
                          "TRAY",
                          "",
                          "",
                          request.responseText.stripScripts()
                        );
                thetisBoxProgress.remove();
                request.responseText.evalScripts();
              }
          }
        );
}
</script>

        <% end %>
        </table>

    </td>
  </tr>
</table>

</form>

<script type="text/javascript">

function doCreate()
{
  if (getListSelected(_z("select_workflow")).length <= 0) {
    msg("<%= t('workflow.select_to_create') %>");
    return;
  }

  var thetisBox = prog("TOP-RIGHT");

  new Ajax.Updater(
          "div_ajax_workflow",
          document.form_workflow.action,
          {
            asynchronous:true,
            evalScripts:true,
            onComplete:function(request){ thetisBox.remove(); },
            parameters:Form.serialize(document.form_workflow)
          }
       );
}

function doDelete(workflow_id, title)
{
  confm("<%= t('paren.square.left') %>" + title + "<%= t('msg.confirm_to_delete') %>", "_doDelete("+workflow_id+")");
}

function _doDelete(workflow_id)
{
  var thetisBox = prog("TOP-RIGHT");

  new Ajax.Updater(
        "div_ajax_workflow",
        "<%= url_for(:controller => 'workflows', :action => 'destroy') %>?id=" + workflow_id,
        {
          parameters:"authenticity_token=<%= form_authenticity_token %>",
          asynchronous:true,
          evalScripts:true,
          onComplete:function(request){ thetisBox.remove(); }
        }
      );
}

function showFolderTreeToSelect(folder_id, workflow_id, title)
{
  var thetisBox = new ThetisBox;
  thetisBox.title = title;
  thetisBox.progress = true;

  var form_tag = "<form action=\"<%= url_for(:controller => 'workflows', :action => 'move') %>?id="+workflow_id+"\" method=\"post\" onsubmit=\"ThetisBox.hide("+thetisBox.id+"); new Ajax.Updater('div_ajax_workflow', this.action, {asynchronous:true, evalScripts:true, onComplete:function(request){__thetisBoxProgress.remove();}, parameters:Form.serialize(this)}); return false;\">";
  thetisBox.setFormTag(form_tag);
  thetisBox.setAdditionalParams(new Array("authenticity_token=<%= form_authenticity_token %>"));
  thetisBox.show("CENTER", "", "TREE", "", "<%= t('item.select_folder_to_move_to')%>", "");
  thetisBox.setTree("<%= url_for(:controller => 'folders', :action => 'ajax_get_tree') %>", folder_id);
}

</script>
