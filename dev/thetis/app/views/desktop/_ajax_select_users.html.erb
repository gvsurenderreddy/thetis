<%
groups_cache = {}
%>

<table id="div_selectUsers" width="95%" cellspacing="0" cellpadding="0" align="center" style="width:95%; height:100%; padding:10px 0px;">
  <tr>
    <td align="center">

      <table width="100%" cellspacing="0" cellpadding="0">
        <tr>
          <td width="130">
            <div class="button_gray" style="float:left;" onClick="showGroupTreeToSelect('<%= (@group_id.nil?)?'':@group_id %>', this);">
              <%= t('btn.select_group') %>
            </div>
          </td>
          <td align="left" style="color:blue;">
            <% unless @group_id.nil? %>
              <%= Group.get_path(@group_id, groups_cache) %>
              &nbsp;<img class="img_btn" src="<%= THETIS_RELATIVE_URL_ROOT %>/images/erase.gif" onclick="doClearGroup();" alt="<%= t('btn.clear') %>" title="<%= t('btn.clear') %>">
            <% end %>
          </td>
        </tr>
      </table>

    <% if @group_id.nil? %>

      <select id="user_candidates" class="select_candidates" size="5" multiple style="width:100%; height:80%;">
      <%
      users_available = {}

      login_groups = @login_user.get_groups_a
      login_groups.each do |group_id|
        group_name = Group.get_path(group_id, groups_cache)
        group_users = Group.get_users(group_id)
        group_users.each do |user|
          user_id = user.id.to_s
          if users_available.keys.include?(user_id)
            users_available[user_id] << group_name
          else
            users_available[user_id] = [group_name]
          end
        end
      end

      login_teams = @login_user.get_teams_a
      login_teams.each do |team_id|
        team_name = Team.get_name(team_id)
        begin
          team = Team.find(team_id)
          team_users = team.get_users_a
        rescue
          team_users = []
        end
        team_users.each do |user_id|
          if users_available.keys.include?(user_id)
            users_available[user_id] << team_name
          else
            users_available[user_id] = [team_name]
          end
        end
      end

      if login_groups.empty? and login_teams.empty?
        users_available[@login_user.id.to_s] = []
      end

      users_available.each do |user_id, org_names|
        disp = User.get_name(user_id, @users_cache)
        disp += ' @ ' + truncate(org_names.join(', '), :length => 50) unless org_names.nil? or org_names.empty?
        if !@users_selected.nil? and @users_selected.include?(user_id)
          next
        end
      %>
        <option value="<%= user_id %>"><%= disp %></option>
      <% end %>
      </select>

    <% else %>

      <select id="user_candidates" class="select_candidates" size="5" multiple style="width:100%; height:80%;">
        <%
        users_available = {}

        unless @users.nil?
          @users.each do |user|
            user_id = user.id.to_s
            users_available[user_id] = user.get_name
          end
        end

        users_available.each do |user_id, name|
          next if !@users_selected.nil? and @users_selected.include?(user_id)
          disp = name
        %>
          <option value="<%= user_id %>"><%= disp %></option>
        <% end %>
      </select>

    <% end %>

    </td>
  </tr>
  <tr style="height:35px;">
    <td align="center" style="padding-top:10px;">

      <table align="center" cellspacing="0" cellpadding="0">
        <tr>
          <td align="right">
            <input type="button" value="<%= t('btn.add') %>" onclick="onPostToOk();" style="width:90px; height:25px">
          </td>
          <td width="10"></td>
          <td align="left">
            <input type="button" value="<%= t('btn.cancel') %>" onclick="ThetisBox.getContainer(this).remove();" style="width:90px; height:25px">
          </td>
        </tr>
      </table>

    </td>
  </tr>
</table>

<script type="text/javascript">

var thetisBoxGroupTree = null;

showGroupTreeToSelect = function(group_id, elem)
{
  if (thetisBoxGroupTree) {
    thetisBoxGroupTree.remove();
    thetisBoxGroupTree = null;
  }
  thetisBoxGroupTree = new ThetisBox;
  thetisBoxGroupTree.title = "<%= t('btn.select_group')%>";
  if (thetisBoxAddPostTo){
    thetisBoxAddPostTo.addChildBox(thetisBoxGroupTree);
  }
  var pos = getPos(elem);
  thetisBoxGroupTree.show((pos.x+elem.offsetWidth+100)+","+(pos.y-20), "", "MINI-TREE", "", "", "");
  thetisBoxGroupTree.setTree("<%= url_for(:controller => 'groups', :action => 'ajax_get_tree') %>", group_id,
    function() {
      var elems = thetisBoxGroupTree.getContainer().getElementsByTagName("A");
      for (var i=0; i < elems.length; i++) {
        addEvent(elems[i], "click", onGroupTreeSelected);
      }
    });
}

onGroupTreeSelected = function(evt)
{
  evt = evt || window.event;
  var elem = evt.target || evt.srcElement;
  for ( ; elem.tagName.toUpperCase() != "A"; elem=elem.parentNode) {
    if (elem.tagName.toUpperCase() == "BODY") {
      return;
    }
  }

  if (!thetisBoxGroupTree) {
    return;
  }
  var addParams = new Array();
  var selKeeper = _z("thetisBoxSelKeeper-"+thetisBoxGroupTree.id);
  addParams.push(selKeeper.name+"="+elem.id);

  var thetisBoxProgress = prog("TOP-RIGHT");

  new Ajax.Updater(
      _z("div_selectUsers").parentNode,
      "<%= url_for(:controller => 'desktop', :action => 'get_group_users') %>",
      {
        method:"get",
        parameters:addParams.join("&"),
        asynchronous:true,
        evalScripts:true,
        onComplete:function(request){
          thetisBoxProgress.remove();
        }
      }
    );
}

doClearGroup = function()
{
  var thetisBox = prog("TOP-RIGHT");

  new Ajax.Updater(
              _z("div_selectUsers").parentNode,
              "<%= url_for(:controller => 'desktop', :action => 'get_group_users') %>",
              {
                method:"get",
                asynchronous:true,
                evalScripts:true,
                onComplete:function(request) {
                  thetisBox.remove();
                }
              }
            );
}

onPostToOk = function()
{
  var ret_ary = moveList(_z("user_candidates"), _z("post_to"));

  ThetisBox.getContainer(_z("div_selectUsers")).remove();
}

</script>
